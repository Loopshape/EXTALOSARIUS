<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AEGIS — Unlimited-Force-Observer Dashboard</title>
<!-- Load Three.js and GSAP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
:root{--bg:#050a10;--fg:#cfe;--accent:#00d2ff;--panel:#0b1620aa}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:'Segoe UI', Inter, Arial, sans-serif; overflow: hidden;}
.app{display:flex;height:100vh;gap:12px;padding:12px;box-sizing:border-box}

/* HUD Styling */
aside{width:380px;background:var(--panel);border: 1px solid #1a3a4a; border-radius:4px;padding:16px;display:flex;flex-direction:column; backdrop-filter: blur(10px);}
main{flex:1;display:flex;flex-direction:column; position: relative;}
canvas{width:100%;height:100%;background:#000;border-radius:4px;display:block; border: 1px solid #1a3a4a;}

h1{margin:0 0 12px 0;font-size:20px; color: var(--accent); text-transform: uppercase; letter-spacing: 2px;}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.card{background:#0f202a88;padding:10px;border-radius:4px;margin-bottom:12px; border-left: 2px solid var(--accent);}
label{display:block;font-size:11px;color:#8ab; text-transform: uppercase; margin-bottom: 4px;}
select,input,button,textarea{width:100%;padding:8px;border-radius:2px;border:1px solid #234;color:#dff;background:#0005; font-family: monospace; box-sizing: border-box;}
button{cursor: pointer; background: #00d2ff22; transition: 0.2s;}
button:hover{background: #00d2ff44; color: #fff;}

.agent-list{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.agent{padding:6px;border-radius:2px;background:#0005;display:flex;flex-direction:column; border: 1px solid #1a3a4a;}
.log{height:140px;overflow:auto;background:#0005;padding:8px;border-radius:2px;font-family:monospace;font-size:11px; color: #8ab;}

/* Overlay UI */
.ufo-label{position:absolute;padding:4px 8px;border-radius:2px;background:rgba(10,20,30,0.8);border: 1px solid var(--accent); color:var(--accent);font-family:monospace;font-size:10px;pointer-events:none;transform:translate(-50%,-50%); transition: opacity 0.3s;}
#stats{white-space: pre-wrap; line-height: 1.4;}
</style>
</head>
<body>
<div class="app">
  <aside>
    <h1>AEGIS Command</h1>
    <div class="card">
      <label>Mission Genesis</label>
      <textarea id="genesisPrompt" rows="2">Initiate 2π/8 crew sequence. Verify Hydro-Plasma ignition.</textarea>
      <button id="genesisBtn">Ignite & Spawn Crew</button>
      <div style="margin-top:8px;"><label>Genesis hash</label><input id="genesisHash" readonly /></div>
    </div>

    <div class="card">
      <label>AI Model Link (Ollama)</label>
      <div class="controls">
        <select id="modelSelect">
          <option value="llama3">llama3</option>
          <option value="mistral">mistral</option>
          <option value="gemma">gemma</option>
          <option value="phi3">phi3</option>
        </select>
        <button id="probeModels">Probe</button>
      </div>
      <div style="margin-top:8px"><label>API URL</label><input id="ollamaUrl" value="http://localhost:11434" /></div>
    </div>

    <div class="card">
      <label>Crew Agents</label>
      <div class="agent-list" id="agents"></div>
      <div style="margin-top:8px"><button id="runCycle">Request Status Report</button></div>
    </div>

    <div class="card">
      <label>System Log</label>
      <div class="log" id="log"></div>
    </div>
  </aside>

  <main>
    <div id="scene-container" style="flex:1; position:relative; overflow:hidden;"></div>
    
    <div style="display:flex;gap:8px;margin-top:8px; height: 150px;">
      <div class="card" style="flex:1; overflow: hidden; display:flex; flex-direction:column;">
        <label>Incoming Transmission</label>
        <div id="agentOutput" class="log" style="flex:1; height:auto;">Awaiting input...</div>
      </div>
      <div class="card" style="width:280px; overflow: hidden; display:flex; flex-direction:column;">
        <label>Telemetry</label>
        <div id="stats" class="log" style="flex:1; height:auto;">Systems Nominal.</div>
      </div>
    </div>
  </main>
</div>

<script type="module">
// ======================= THREE.JS AEGIS SETUP =======================

const container = document.getElementById('scene-container');
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x050a10, 0.02); // Deep space fog

// Camera Setup (60° angled view logic handled in update)
const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.setPixelRatio(window.devicePixelRatio);
renderer.toneMapping = THREE.ACESFilmicToneMapping;
container.appendChild(renderer.domElement);

// --- Lighting ---
const ambientLight = new THREE.AmbientLight(0x404040, 0.5); // Soft white light
scene.add(ambientLight);

const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
sunLight.position.set(100, 50, 50);
scene.add(sunLight);

const engineLight = new THREE.PointLight(0x00ffff, 1, 20);
engineLight.position.set(-8, 0, 0);
scene.add(engineLight);

// --- 1. The Earth ---
const earthGeo = new THREE.SphereGeometry(40, 64, 64);
const earthMat = new THREE.MeshStandardMaterial({ 
    color: 0x112244, 
    roughness: 0.8,
    emissive: 0x000510,
    emissiveIntensity: 0.5
});
const earth = new THREE.Mesh(earthGeo, earthMat);
earth.position.set(0, -50, 0); // Earth below
scene.add(earth);

// --- 2. The AEGIS Carrier (Procedural Construction) ---
const aegisGroup = new THREE.Group();
scene.add(aegisGroup);

// Materials
const hullMat = new THREE.MeshStandardMaterial({ color: 0x8899aa, roughness: 0.3, metalness: 0.8 });
const darkMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.7, metalness: 0.5 });
const windowMat = new THREE.MeshStandardMaterial({ color: 0x000000, roughness: 0.0, metalness: 1.0, emissive: 0x001133 });
const glowMat = new THREE.MeshBasicMaterial({ color: 0x00ffff }); // Engine core

// A. Central Spine
const spineGeo = new THREE.BoxGeometry(12, 1.5, 3);
const spine = new THREE.Mesh(spineGeo, hullMat);
aegisGroup.add(spine);

// B. Cockpit (Front)
const cockpitGeo = new THREE.CylinderGeometry(0.5, 1.5, 3, 8);
cockpitGeo.rotateZ(Math.PI / 2);
cockpitGeo.translate(6.5, 0, 0);
const cockpit = new THREE.Mesh(cockpitGeo, hullMat);
aegisGroup.add(cockpit);

// B.2 Dashboard Window
const winGeo = new THREE.BoxGeometry(1.5, 0.8, 1.8);
winGeo.translate(7.2, 0.2, 0);
const windowMesh = new THREE.Mesh(winGeo, windowMat);
aegisGroup.add(windowMesh);

// C. Wings / Secondary Hulls
const wingGeo = new THREE.BoxGeometry(6, 0.5, 10);
const lWing = new THREE.Mesh(wingGeo, hullMat);
lWing.position.set(-2, -0.2, 4);
lWing.rotation.x = 0.2;
lWing.rotation.z = -0.1;
aegisGroup.add(lWing);

const rWing = new THREE.Mesh(wingGeo, hullMat);
rWing.position.set(-2, -0.2, -4);
rWing.rotation.x = -0.2;
rWing.rotation.z = -0.1;
aegisGroup.add(rWing);

// D. Engines (The 3 Poles)
const engineGeo = new THREE.CylinderGeometry(0.6, 0.8, 2, 16);
engineGeo.rotateZ(Math.PI / 2);

const engines = [];
const enginePos = [
    { x: -6, y: 0.8, z: 0 },    // Top Center
    { x: -6, y: -0.5, z: 1.5 }, // Bottom Left
    { x: -6, y: -0.5, z: -1.5 } // Bottom Right
];

enginePos.forEach((pos, i) => {
    const housing = new THREE.Mesh(engineGeo, darkMat);
    housing.position.set(pos.x, pos.y, pos.z);
    
    // The glowing plasma core
    const coreGeo = new THREE.ConeGeometry(0.4, 3, 16);
    coreGeo.rotateZ(-Math.PI / 2);
    coreGeo.translate(-1.5, 0, 0);
    const core = new THREE.Mesh(coreGeo, glowMat.clone()); // Clone for individual animation
    housing.add(core);
    
    aegisGroup.add(housing);
    engines.push(core); // Store ref for animation
});

// --- 3. Starfield ---
const starGeo = new THREE.BufferGeometry();
const starCount = 2000;
const starPos = new Float32Array(starCount * 3);
for(let i=0; i<starCount*3; i++) {
    starPos[i] = (Math.random() - 0.5) * 400;
}
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
const starMat = new THREE.PointsMaterial({color: 0xffffff, size: 0.3, transparent: true, opacity: 0.8});
const stars = new THREE.Points(starGeo, starMat);
scene.add(stars);


// ======================= LOGIC BRIDGE =======================

const agentNames = ['Coordinator','Navigator','Doctor','Predictor','Adviser','Constellator','Marketer','Communicator'];
let agentsData = [];
let agentMeshes = [];

// Helper: Text Label Overlay
function createLabel(text) {
    const div = document.createElement('div');
    div.className = 'ufo-label';
    div.textContent = text;
    document.body.appendChild(div);
    return div;
}

function spawnAgents3D(hash) {
    // Clear old
    agentMeshes.forEach(m => {
        scene.remove(m.mesh);
        if(m.label) m.label.remove();
    });
    agentMeshes = [];
    agentsData = [];

    const count = 8;
    const radius = 14; // Orbit radius around AEGIS

    for(let i=0; i<count; i++) {
        // Data Logic
        const name = agentNames[i];
        const angle = (i / count) * Math.PI * 2;
        
        // Visual Logic (Satellite drones)
        const geo = new THREE.OctahedronGeometry(0.3);
        const mat = new THREE.MeshBasicMaterial({ color: 0x00ffaa, wireframe: true });
        const mesh = new THREE.Mesh(geo, mat);
        
        // Initial pos
        mesh.position.set(
            Math.cos(angle) * radius,
            0,
            Math.sin(angle) * radius
        );
        
        scene.add(mesh);
        
        const label = createLabel(name);

        const agentObj = {
            id: i,
            name: name,
            mesh: mesh,
            label: label,
            angle: angle,
            radius: radius,
            speed: 0.005 + (Math.random() * 0.005)
        };
        
        agentMeshes.push(agentObj);
        agentsData.push(agentObj);
    }
    renderAgentsList();
}

function renderAgentsList(){ 
  const wrap = document.getElementById('agents'); wrap.innerHTML='';
  agentsData.forEach(a=>{
    const el = document.createElement('div'); el.className='agent';
    el.innerHTML = `<strong>${a.name}</strong><small>Status: Active</small>`;
    wrap.appendChild(el);
  }); 
}

// --- Animation Loop ---
let time = 0;

function animate() {
    requestAnimationFrame(animate);
    time += 0.01;

    // 1. Earth Rotation
    earth.rotation.y += 0.0005;

    // 2. AEGIS Movement (Subtle float)
    aegisGroup.rotation.z = Math.sin(time * 0.5) * 0.05;
    aegisGroup.rotation.y = Math.sin(time * 0.2) * 0.02;

    // 3. Engine Logic: "Pulse 2, Flicker 1"
    // Engine 0 & 1 (Top/Left) Pulse smoothly
    const pulse = 1 + Math.sin(time * 10) * 0.5;
    engines[0].scale.setScalar(pulse);
    engines[0].material.opacity = 0.5 + pulse * 0.2;
    engines[1].scale.setScalar(pulse);
    
    // Engine 2 (Right) Flickers
    const flicker = 0.8 + Math.random() * 0.6;
    engines[2].scale.setScalar(flicker);
    engines[2].material.color.setHSL(0.5, 1, 0.5 + Math.random()*0.5);

    // 4. Update Agents (Satellites orbiting the ship)
    agentMeshes.forEach(a => {
        a.angle += a.speed;
        // Orbit logic around AEGIS
        a.mesh.position.x = Math.cos(a.angle) * a.radius;
        a.mesh.position.z = Math.sin(a.angle) * a.radius;
        a.mesh.position.y = Math.sin(a.angle * 2) * 2; // Undulate
        
        a.mesh.rotation.x += 0.02;
        a.mesh.rotation.y += 0.02;

        // Project Label to Screen
        updateLabelPosition(a.mesh, a.label);
    });

    // 5. Camera Follow (60 degree angled from top)
    // We keep camera static relative to scene, but look at ship
    const targetPos = aegisGroup.position.clone();
    camera.position.set(20, 15, 20); // The "60 degree" spot
    camera.lookAt(targetPos);

    renderer.render(scene, camera);
}

function updateLabelPosition(mesh, label) {
    if(!label) return;
    const tempV = new THREE.Vector3();
    mesh.updateWorldMatrix(true, false);
    mesh.getWorldPosition(tempV);
    
    tempV.project(camera);
    
    const x = (tempV.x * .5 + .5) * container.clientWidth;
    const y = (tempV.y * -.5 + .5) * container.clientHeight;
    
    if(Math.abs(tempV.z) > 1) { // clipped
         label.style.opacity = 0;
    } else {
         label.style.opacity = 1;
         label.style.left = `${x}px`;
         label.style.top = `${y}px`;
    }
}


// ======================= UI & INTERACTION =======================

function log(s){ const l = document.getElementById('log'); l.innerText = `[${new Date().toLocaleTimeString()}] ${s}\n`+l.innerText; }
async function sha256hex(str){ const enc = new TextEncoder().encode(str); const hash = await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

// Init
window.addEventListener('resize', () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
});

document.getElementById('genesisBtn').addEventListener('click', async ()=>{
  const prompt = document.getElementById('genesisPrompt').value; 
  const hash = await sha256hex(prompt);
  document.getElementById('genesisHash').value = hash;
  log(`SEQUENCE INITIATED: ${hash.substring(0,8)}...`);
  spawnAgents3D(hash);
});

// Mock Ollama interaction (or real if local server is running)
document.getElementById('runCycle').addEventListener('click', async ()=>{
  const ollamaUrl = document.getElementById('ollamaUrl').value;
  const model = document.getElementById('modelSelect').value;
  
  log(`Broadcasting to ${agentsData.length} stations via ${model}...`);
  
  // Simulate parallel requests
  const tasks = agentsData.map(async (a) => {
    // Pulse the agent mesh to show activity
    gsap.to(a.mesh.scale, {x:2, y:2, z:2, duration:0.2, yoyo:true, repeat:1});
    
    try {
        // Real fetch attempt
        const res = await fetch(`${ollamaUrl}/api/generate`, {
            method:'POST',
            body: JSON.stringify({model: model, prompt: `Roleplay as spaceship crew member ${a.name}. Status report?`, stream: false})
        });
        const data = await res.json();
        return `${a.name}: ${data.response}`;
    } catch(e) {
        // Fallback simulation
        await new Promise(r => setTimeout(r, 500 + Math.random()*1000));
        const responses = [
            "Detecting gravity fluctuations.",
            "Hydro-plasma levels stable.",
            "Trajectory aligned with Earth orbit.",
            "Communications clear.",
            "Crew vitals nominal.",
            "Shield integrity at 98%."
        ];
        return `${a.name}: ${responses[Math.floor(Math.random()*responses.length)]}`;
    }
  });

  const results = await Promise.all(tasks);
  document.getElementById('agentOutput').innerText = results.join('\n\n');
  log("Report cycle complete.");
});

document.getElementById('probeModels').addEventListener('click', async ()=>{
  const ollamaUrl = document.getElementById('ollamaUrl').value;
  try{ 
      const res = await fetch(`${ollamaUrl}/api/tags`); 
      const data = await res.json(); 
      log(`Available Models: ${data.models.map(m=>m.name).join(', ')}`); 
  } catch(e){
      log('Probe failed - Is Ollama running?');
  }
});

// Start Animation
spawnAgents3D('init');
animate();

</script>
</body>
</html>
